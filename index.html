<!DOCTYPE html>
<html>

<head>
	<title>Hiking Map</title>
	<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
	<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<link href="css/main.css" rel="stylesheet" />
	<script src="https://npmcdn.com/@turf/turf@5.1.6/turf.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.0/moment.min.js"></script>
</head>

<body>
	<div id="map-wrapper">
		<div id="map"></div>
		<div id="map-list">
			<ul id="map-list-items"></ul>
		</div>
	</div>
	<script>
		function reduceMarks(range, n){
			var marks=[]
			for( var i = 0 ; i < range.length ; i += n){
				marks.push(range[i]);
			}
			return marks;
		}

		var numberOfRoutes = 13;
		mapboxgl.accessToken = "pk.eyJ1IjoieWZ0c29peWZ0c29pIiwiYSI6ImNqcnAweTdsbTE5OG40NHA5b2VvaW05Y3UifQ.W_WnayZjcP21QE4h-eFYYQ";
		var map = new mapboxgl.Map({
			container: "map",
			style: "mapbox://styles/yftsoiyftsoi/cjrp3f4uk5m1n2spc8w7jrqoi",
			center: [114.1535941, 22.3700556],
			zoom: 10.5
		});
		var mapData = {};
		var defaultColor = '#ef476f';
		var selectedColor = '#073b4c';
		map.on('load', function () {
			// map.loadImage('footprint_4.png', function (err, image) {
			// map.addImage('footprintpattern', image);
				for (var i = 1; i <= numberOfRoutes; i++) {
					(function (index) {
						$.getJSON('./geojson/' + index + '.geojson', function (data) {
							// data.features[0].geometry.coordinates = reduceMarks(data.features[0].geometry.coordinates, 1);
							mapData[index] = {
								name: data.features[0].properties.name,
								time: moment(data.features[0].properties.time).format('YYYY-MM-DD HH:mm:ss'),
								length: turf.length(data.features[0]).toLocaleString(),
								data: data
							};
							map.addSource('route' + index, {
								'type': 'geojson',
								'data': data
							});
							map.addLayer({
								'id': 'route' + index,
								'type': 'line',
								'source': 'route' + index,
								'layout': {
									'line-join': 'round',
									'line-cap': 'round'
								},
								'paint': {
									// 'line-pattern': 'footprintpattern',
									'line-color': defaultColor,
									'line-width': 2
								}
							});
							triggerSorting();
						});
					})(i);
				}
			// });
		});
		var selectedRoute = null;
		var template = '<li data-index="{index}"><div class="title"><strong>{name}</strong></div><div class="time">{time}</time><div class="length">{length}</div></li>';
		var loaded = 0;
		function triggerSorting() {
			loaded++;
			var keys = Object.keys(mapData).sort(function(a, b){return b-a});
			var total = 0;
			$('#map-list-items').html('');
			keys.forEach(function(key){
				var newTemplate = template.replace('{name}', mapData[key].name.replace('**', ''));
				newTemplate = newTemplate.replace('{time}', mapData[key].time);
				newTemplate = newTemplate.replace('{length}', mapData[key].length + 'km');
				newTemplate = newTemplate.replace('{index}', key);
				$('#map-list-items').append(newTemplate);
				total += parseFloat(mapData[key].length);
			});
			if(loaded === numberOfRoutes){
				$('#map-list-items').prepend('<li class="summary"><span class="text">Total:</span><span class="total">' + total.toFixed(2) +'km</span></li>');
			}
		}
		var lastSelectedLayer = null;
		$('body').on('click', '#map-list-items li', function(e){
			e.preventDefault();
			$('#map-list-items li').removeClass('active');
			if($(this).is(':not(.summary)')){
				$(this).addClass('active');
				var index = $(this).data('index');
				if(lastSelectedLayer){
					map.setPaintProperty('route' + lastSelectedLayer, 'line-color', defaultColor);
					map.setPaintProperty('route' + lastSelectedLayer, 'line-width', 1);
				}
				lastSelectedLayer = index;
				if(typeof index !== 'undefined' && typeof mapData[index].data !== 'undefined'){
					var coordinates = mapData[index].data.features[0].geometry.coordinates;
					var bounds = coordinates.reduce(function (bounds, coord) {
						return bounds.extend(coord);
					}, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));

					map.fitBounds(bounds, {
						padding: 20
					});
					map.setPaintProperty('route' + lastSelectedLayer, 'line-color', selectedColor);
					map.setPaintProperty('route' + lastSelectedLayer, 'line-width', 2);
				}
			}
		});
	</script>
</body>

</html>