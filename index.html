<!DOCTYPE html>
<html>

<head>
	<title>Hiking Map</title>
	<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@1,300&display=swap" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
	<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<link href="css/main.css" rel="stylesheet" />
	<script src="https://npmcdn.com/@turf/turf@5.1.6/turf.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.0/moment.min.js"></script>
</head>

<body>
	<div id="map-wrapper">
		<div id="map"></div>
		<div id="map-list">
			<ul id="map-list-items"></ul>
		</div>
	</div>
	<script>
		mapboxgl.accessToken = "pk.eyJ1IjoieWZ0c29peWZ0c29pIiwiYSI6ImNqcnAweTdsbTE5OG40NHA5b2VvaW05Y3UifQ.W_WnayZjcP21QE4h-eFYYQ";
		var map = new mapboxgl.Map({
			container: "map",
			style: "mapbox://styles/yftsoiyftsoi/cjrp3f4uk5m1n2spc8w7jrqoi",
			center: [114.1535941, 22.3700556],
			zoom: 10.5
		});
		var numberOfRoutes = 9;
		var mapData = {};
		map.on('load', function () {
			for (var i = 1; i <= numberOfRoutes; i++) {
				(function (index) {
					$.getJSON('./geojson/' + index + '.geojson', function (data) {
						mapData[index] = {
							name: data.features[0].properties.name,
							time: moment(data.features[0].properties.time).format('YYYY-MM-DD HH:mm:ss'),
							length: turf.length(data.features[0]).toLocaleString()
						};
						map.addSource('route' + index, {
							'type': 'geojson',
							'data': data
						});
						map.addLayer({
							'id': 'route' + index,
							'type': 'line',
							'source': 'route' + index,
							'layout': {
								'line-join': 'round',
								'line-cap': 'round'
							},
							'paint': {
								'line-color': 'rgba(255, 65, 77, 1)',
								'line-width': 2
							}
						});
						triggerSorting();
					});
				})(i);
			}
		});
		var selectedRoute = null;
		var template = '<li><div class="title"><strong>{name}</strong></div><div class="time">{time}</time><div class="length">{length}</div></li>';
		var loaded = 0;
		function triggerSorting() {
			loaded++;
			var keys = Object.keys(mapData).sort();
			var total = 0;
			keys.forEach(function(key){
				var newTemplate = template.replace('{name}', mapData[key].name.replace('**', ''));
				newTemplate = newTemplate.replace('{time}', mapData[key].time);
				newTemplate = newTemplate.replace('{length}', mapData[key].length + 'km');
				$('#map-list-items').append(newTemplate);
				total += parseFloat(mapData[key].length);
			});
			if(loaded === numberOfRoutes){
				$('#map-list-items').prepend('<li class="summary"><span class="text">Total:</span><span class="total">' + total.toFixed(2) +'km</span></li>');
			}
		}
	</script>
</body>

</html>